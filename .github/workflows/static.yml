name: Update Scholar CV
on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Tor and configure BEFORE starting
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y tor netcat-openbsd

          # Stop Tor if apt auto-started it with the default config
          sudo service tor stop || true

          # Write torrc flush-left — any leading whitespace makes Tor reject the file
          sudo bash -c 'cat > /etc/tor/torrc << "TOREOF"
SocksPort 9050
ControlPort 9051
CookieAuthentication 0
HashedControlPassword ""
MaxCircuitDirtiness 10
NewCircuitPeriod 10
Log notice file /var/log/tor/notices.log
TOREOF'

          echo "--- /etc/tor/torrc ---"
          cat /etc/tor/torrc
          echo "----------------------"

          sudo service tor start

          echo "Waiting for Tor bootstrap..."
          for i in $(seq 1 60); do
            if sudo grep -q "Bootstrapped 100%" /var/log/tor/notices.log 2>/dev/null \
            || sudo grep -q "Bootstrapped 100%" /var/log/tor/log 2>/dev/null; then
              echo "Tor bootstrapped at iteration $i"
              break
            fi
            sleep 2
          done

          nc -z 127.0.0.1 9050 && echo "SOCKS port 9050 open" \
            || { echo "SOCKS port not open - aborting"; exit 1; }

          nc -z 127.0.0.1 9051 && echo "Control port 9051 open" \
            || { echo "Control port not open - aborting"; exit 1; }

          echo "Initial exit IP:"
          curl -s --socks5-hostname 127.0.0.1:9050 https://api.ipify.org && echo ""

      - name: Find a clean Tor exit node for Google Scholar
        run: |
          python3 - <<'EOF'
          import socket, time, requests, sys

          TOR_PROXIES = {
              'http':  'socks5h://127.0.0.1:9050',
              'https': 'socks5h://127.0.0.1:9050',
          }
          HEADERS = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; rv:109.0) Gecko/20100101 Firefox/115.0'
          }

          def renew():
              try:
                  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                  s.settimeout(10)
                  s.connect(('127.0.0.1', 9051))
                  s.sendall(b'AUTHENTICATE ""\r\nSIGNAL NEWNYM\r\nQUIT\r\n')
                  resp = s.recv(1024).decode()
                  s.close()
                  return '250' in resp
              except Exception as e:
                  print(f'  renew failed: {e}')
                  return False

          def get_ip():
              try:
                  return requests.get('https://api.ipify.org',
                                      proxies=TOR_PROXIES, timeout=15).text.strip()
              except Exception:
                  return 'unknown'

          def scholar_ok():
              try:
                  r = requests.get('https://scholar.google.com',
                                   proxies=TOR_PROXIES,
                                   headers=HEADERS,
                                   timeout=20)
                  bad = ('unusual traffic' in r.text.lower() or
                         'captcha' in r.text.lower() or
                         r.status_code in (429, 503))
                  return not bad
              except Exception:
                  return False

          for probe in range(1, 16):
              ip = get_ip()
              print(f'Probe {probe}/15 — exit IP: {ip}', end=' ', flush=True)
              if scholar_ok():
                  print('CLEAN - proceeding')
                  sys.exit(0)
              print('BLOCKED - rotating...')
              renew()
              time.sleep(8)

          print('WARNING: Could not find clean node in 15 probes — script may fail')
          EOF

          echo "Final exit IP:"
          curl -s --socks5-hostname 127.0.0.1:9050 https://api.ipify.org && echo ""

      - name: Pre-install geckodriver (scholarly Firefox fallback)
        run: |
          GECKO_VERSION=$(curl -s https://api.github.com/repos/mozilla/geckodriver/releases/latest \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'])")
          echo "Installing geckodriver $GECKO_VERSION"
          wget -q "https://github.com/mozilla/geckodriver/releases/download/${GECKO_VERSION}/geckodriver-${GECKO_VERSION}-linux64.tar.gz"
          tar -xzf geckodriver-*.tar.gz
          sudo mv geckodriver /usr/local/bin/
          geckodriver --version

      - name: Restore checkpoint (resume interrupted run)
        uses: actions/cache@v4
        with:
          path: checkpoint.json
          key: scholar-checkpoint-${{ github.run_id }}
          restore-keys: |
            scholar-checkpoint-

      - name: Run CV script
        run: python cv+.py

      - name: Save checkpoint on failure
        if: failure()
        uses: actions/cache/save@v4
        with:
          path: checkpoint.json
          key: scholar-checkpoint-${{ github.run_id }}

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add cv_formatted.txt publications.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update CV [skip ci]"
            git push
          fi
