name: Update Scholar CV
on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Tor and configure BEFORE starting
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y tor

          # Write full config BEFORE starting Tor
          # (appending after start is too late — service must restart to pick it up)
          sudo tee /etc/tor/torrc > /dev/null <<'EOF'
          SocksPort 9050
          ControlPort 9051
          CookieAuthentication 0
          HashedControlPassword ""
          MaxCircuitDirtiness 10
          NewCircuitPeriod 10
          EOF

          # Start Tor with the new config
          sudo service tor start

          # Wait for full bootstrap by polling the log
          echo "Waiting for Tor bootstrap..."
          for i in $(seq 1 60); do
            if sudo grep -q "Bootstrapped 100%" /var/log/tor/log 2>/dev/null; then
              echo "✅ Tor bootstrapped at iteration $i"
              break
            fi
            sleep 2
          done

          # Verify SOCKS port is listening
          echo "Checking SOCKS port 9050..."
          nc -z 127.0.0.1 9050 && echo "✅ SOCKS port open" || echo "❌ SOCKS port not open"

          # Verify control port is listening
          echo "Checking control port 9051..."
          nc -z 127.0.0.1 9051 && echo "✅ Control port open" || echo "❌ Control port not open"

          # Show current exit IP
          curl -s --socks5-hostname 127.0.0.1:9050 https://api.ipify.org && echo ""

      - name: Rotate Tor circuit before first Scholar request
        run: |
          # The initial exit node may already be blocked by Google Scholar.
          # Request a new identity 3 times to maximise chance of a clean exit node.
          python3 - <<'EOF'
          import socket, time

          def send_newnym():
              try:
                  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                  s.connect(('127.0.0.1', 9051))
                  s.sendall(b'AUTHENTICATE ""\r\nSIGNAL NEWNYM\r\nQUIT\r\n')
                  resp = s.recv(1024).decode()
                  s.close()
                  return '250' in resp
              except Exception as e:
                  print(f'  ⚠️  Raw socket NEWNYM failed: {e}')
                  return False

          for i in range(3):
              print(f'  Rotating circuit {i+1}/3...')
              ok = send_newnym()
              print(f'  {"✅ Done" if ok else "⚠️  Failed"}')
              time.sleep(8)

          print('Circuit rotation complete.')
          EOF

          # Show new exit IP
          echo "New exit IP:"
          curl -s --socks5-hostname 127.0.0.1:9050 https://api.ipify.org && echo ""

      - name: Pre-install geckodriver
        run: |
          GECKO_VERSION=$(curl -s https://api.github.com/repos/mozilla/geckodriver/releases/latest \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'])")
          echo "Installing geckodriver $GECKO_VERSION"
          wget -q "https://github.com/mozilla/geckodriver/releases/download/${GECKO_VERSION}/geckodriver-${GECKO_VERSION}-linux64.tar.gz"
          tar -xzf geckodriver-*.tar.gz
          sudo mv geckodriver /usr/local/bin/
          geckodriver --version

      - name: Restore checkpoint (resume interrupted run)
        uses: actions/cache@v4
        with:
          path: checkpoint.json
          key: scholar-checkpoint-${{ github.run_id }}
          restore-keys: |
            scholar-checkpoint-

      - name: Run CV script
        run: python cv+.py

      - name: Save checkpoint on failure
        if: failure()
        uses: actions/cache/save@v4
        with:
          path: checkpoint.json
          key: scholar-checkpoint-${{ github.run_id }}

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add cv_formatted.txt publications.json

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update CV [skip ci]"
            git push
          fi
